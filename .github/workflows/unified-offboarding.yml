name: unified-offboarding

on:
  push:
    branches:
      - "feat/unified-offboarding"  
  workflow_dispatch:
    inputs:
      clickup_task:
        description: "ClickUp task ID"
        required: true
        type: string
        default: "INS-3472"

      user_email:
        description: "Optional override for Email (otherwise extracted from ClickUp task name)"
        required: false
        type: string
        default: ""

      dry_run:
        description: "If true, no actual changes are made (dry run mode)"
        required: false
        type: boolean
        default: false

      tools_all:
        description: "Select all tools (GitHub + Atlas). If true, overrides individual tool selections."
        required: false
        type: boolean
        default: false

      tool_github:
        description: "Offboard from GitHub organization"
        required: false
        type: boolean
        default: true

      tool_atlas:
        description: "Offboard from Atlas databases (all db groups)"
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

jobs:
  unified_offboard:
    runs-on: self-runner-dind-infra
    env:
      AWS_IAM_ROLE: ${{ vars.AWS_IAM_ROLE }}
      AWS_REGION: ${{ vars.AWS_REGION }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_IAM_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Mint GitHub App installation token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.ORG_APP_ID }}
          private-key: ${{ secrets.ORG_APP_PRIVATE_KEY }}
          owner: smallcase

      - name: Install dependencies
        run: pip install -r ./requirements/requirements-github.txt

      - name: Run unified offboarding
        env:
          ORG_ADMIN_TOKEN: ${{ steps.app-token.outputs.token }}
          DEFAULT_ORG: smallcase

          # For reading username from Github.active_users
          GITHUB_AUDIT_MONGO_URI: ${{ secrets.MONGO_URI }}
          GITHUB_AUDIT_DB: Github
          GITHUB_AUDIT_COLL: active_users

          # For writing offboarded_users audit entry
          MONGO_URI: ${{ secrets.MONGO_URI }}
          MONGO_DB_NAME: Github
          MONGO_COLLECTION: offboarded_users

          INVITED_BY: ${{ github.actor }}

          # Inputs
          CLICKUP_TASK: ${{ github.event.inputs.clickup_task || 'INS-3472' }}
          USER_EMAIL:  ${{ github.event.inputs.user_email || '' }}
          DRY_RUN:     ${{ github.event.inputs.dry_run == true && 'true' || 'false' }}
          TOOLS_ALL:   ${{ github.event.inputs.tools_all == true && 'true' || 'false' }}
          TOOL_GITHUB: ${{ github.event.inputs.tool_github != false && 'true' || 'false' }}
          TOOL_ATLAS:  ${{ github.event.inputs.tool_atlas == true && 'true' || 'false' }}

        run: |
          cd offboarding
          
          # Determine which tools to run
          TOOLS_LIST=""
          if [ "${TOOLS_ALL}" = "true" ]; then
            TOOLS_LIST="github,atlas"
          else
            if [ "${TOOL_GITHUB}" = "true" ]; then
              TOOLS_LIST="github"
            fi
            if [ "${TOOL_ATLAS}" = "true" ]; then
              if [ -n "${TOOLS_LIST}" ]; then
                TOOLS_LIST="${TOOLS_LIST},atlas"
              else
                TOOLS_LIST="atlas"
              fi
            fi
          fi
          
          # Default to github if no tools selected
          if [ -z "${TOOLS_LIST}" ]; then
            TOOLS_LIST="github"
          fi
          
          echo "CLICKUP_TASK=${CLICKUP_TASK}"
          echo "USER_EMAIL=${USER_EMAIL}"
          echo "DRY_RUN=${DRY_RUN}"
          echo "TOOLS=${TOOLS_LIST}"
          
          python unified_offboarding.py \
            --clickup-task "${CLICKUP_TASK}" \
            --tools "${TOOLS_LIST}" \
            $( [ -n "${USER_EMAIL}" ] && echo "--email ${USER_EMAIL}" ) \
            $( [ "${DRY_RUN}" = "true" ] && echo "--dry-run" || true )