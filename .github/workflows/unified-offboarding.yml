name: unified-offboarding

on:
  push:
    branches:
      - "feat/unified-offboarding"  
  workflow_dispatch:
    inputs:
      clickup_task:
        description: "ClickUp task ID"
        required: true
        type: string
        default: "INS-3472"

      user_email:
        description: "Optional override for Email (otherwise extracted from ClickUp task name)"
        required: false
        type: string
        default: ""

      tools:
        description: "Tools to offboard from (comma-separated). Options: github, atlas, or 'all'. Examples: 'github', 'atlas', 'github,atlas', 'all'"
        required: false
        type: string
        default: "github"

      dry_run:
        description: "Dry run mode (no actual changes)"
        required: false
        type: choice
        options:
          - no
          - yes
        default: yes

permissions:
  id-token: write
  contents: read

jobs:
  unified_offboard:
    runs-on: self-runner-dind-infra
    env:
      AWS_IAM_ROLE: ${{ vars.AWS_IAM_ROLE }}
      AWS_REGION: ${{ vars.AWS_REGION }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_IAM_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Mint GitHub App installation token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.ORG_APP_ID }}
          private-key: ${{ secrets.ORG_APP_PRIVATE_KEY }}
          owner: smallcase

      - name: Install dependencies
        run: pip install -r ./requirements/requirements-github.txt

      - name: Run unified offboarding
        env:
          ORG_ADMIN_TOKEN: ${{ steps.app-token.outputs.token }}
          DEFAULT_ORG: smallcase

          # For reading username from Github.active_users
          GITHUB_AUDIT_MONGO_URI: ${{ secrets.MONGO_URI }}
          GITHUB_AUDIT_DB: Github
          GITHUB_AUDIT_COLL: active_users

          # For writing offboarded_users audit entry
          MONGO_URI: ${{ secrets.MONGO_URI }}
          MONGO_DB_NAME: Github
          MONGO_COLLECTION: offboarded_users

          INVITED_BY: ${{ github.actor }}

          # Inputs
          CLICKUP_TASK: ${{ github.event.inputs.clickup_task || 'INS-3472' }}
          USER_EMAIL:  ${{ github.event.inputs.user_email || '' }}
          TOOLS_INPUT: ${{ github.event.inputs.tools || 'github' }}
          DRY_RUN_INPUT: ${{ github.event.inputs.dry_run || 'yes' }}

        run: |
          cd offboarding
          
          # Process tools input (supports: "github", "atlas", "github,atlas", "all")
          TOOLS_INPUT_LOWER=$(echo "${TOOLS_INPUT}" | tr '[:upper:]' '[:lower:]' | xargs)
          
          if [ "${TOOLS_INPUT_LOWER}" = "all" ]; then
            TOOLS_LIST="github,atlas"
          else
            # Use the input as-is (already comma-separated if multiple)
            # Normalize: remove spaces, convert to lowercase
            TOOLS_LIST=$(echo "${TOOLS_INPUT_LOWER}" | tr -d ' ' | tr ',' '\n' | sort -u | tr '\n' ',' | sed 's/,$//')
            
            # Default to github if empty
            if [ -z "${TOOLS_LIST}" ]; then
              TOOLS_LIST="github"
            fi
          fi
          
          # Convert dry_run dropdown to flag
          DRY_RUN_FLAG=""
          if [ "${DRY_RUN_INPUT}" = "yes" ]; then
            DRY_RUN_FLAG="--dry-run"
          fi
          
          echo "CLICKUP_TASK=${CLICKUP_TASK}"
          echo "USER_EMAIL=${USER_EMAIL}"
          echo "TOOLS=${TOOLS_LIST}"
          echo "DRY_RUN=${DRY_RUN_INPUT}"
          
          python unified_offboarding.py \
            --clickup-task "${CLICKUP_TASK}" \
            --tools "${TOOLS_LIST}" \
            $( [ -n "${USER_EMAIL}" ] && echo "--email ${USER_EMAIL}" ) \
            $( [ -n "${DRY_RUN_FLAG}" ] && echo "${DRY_RUN_FLAG}" )