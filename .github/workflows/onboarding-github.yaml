name: github-onboarding-butler

run-name: "GitHub Onboarding | ClickUp: ${{ inputs.clickup_task }} | Triggered by ${{ github.actor }}"

on:
  workflow_dispatch:
    inputs:
      clickup_task:
        description: 'ClickUp task id to pull Email and GitHub Username from the form'
        required: true
        type: string
      teams:
        description: 'Comma-separated team slugs (e.g., core-infra,infra-intern)'
        required: false
        type: string
      role:
        description: 'Org role (direct_member or admin)'
        required: false
        default: 'direct_member'
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  onboard_github_user:
    runs-on: self-runner-dind-infra
    env:
      AWS_IAM_ROLE: ${{ vars.AWS_IAM_ROLE }}
      AWS_REGION: ${{ vars.AWS_REGION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_IAM_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests pymongo dnspython certifi boto3 google-api-python-client google-auth

      - name: Run onboarding
        env:
          ORG_ADMIN_TOKEN: ${{ secrets.ORG_ADMIN_TOKEN }}
          MONGO_URI: ${{ secrets.MONGO_URI }}
          DEFAULT_ORG: smallcase
          MONGO_DB_NAME: Github
          MONGO_COLLECTION: active_users
          INVITED_BY: ${{ github.actor }}
        run: |
          cd onboarding
          python github_onboarding.py \
            --clickup-task "${{ github.event.inputs.clickup_task }}" \
            --teams "${{ github.event.inputs.teams }}" \
            --role "${{ github.event.inputs.role }}"